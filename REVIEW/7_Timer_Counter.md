# 7. 8비트 타이머/카운터의 동작  
> **<목차>**  
> 7.1 타이머/카운터 개요  
> 7.2 8비트 타이머/카운터2의 동작  
> 7.3 8비트 타이머/카운터0의 동작  
> 7.4 8비트 타이머/카운터 활용 실험  
> - 일반 모드  
> - CTC 모드  
> - 고속 PWM 모드  
> - PC PWM 모드  

<br>

## 7.1 타이머/카운터 개요  
- 타이머/카운터 개요
  + 클럭이 입력되면 들어오는 클럭을 계수하는 기능 
  + 타이머/카운터의 각 단계는 입력 클럭을 *2분주* 하여 동작하는 하나의 D 플립플롭 (D-type negative edge-triggered)으로 되어있으며, D플립플롭의 출력은 다음 단의 D 입력에 연결되어 있음
  + 오버플로우 : 3-비트 타이머/카운터의 경우 카운터의 상태가 111에서 000으로 변화할 때 발생함. -> 플래그 플립플롭에 오버플로우가 발생했음을 알림  

<br>

- 타이머/카운터의 구분
  + 타이머 모드 : MCU의 ***내부*** 클럭을 입력으로 사용하여 이를 분주해서 클럭 소스로 사용하는 경우
  + 카운터 모드 : MCU의 ***외부***에서 입력되는 클럭 신호를 받아서 이를 클럭 소스로 사용하는 경우
  + ATmega128의 타이머/카운터
    * 2개의 8비트 타이머/카운터 (T0, T2)
    * 2개의 16비트 타이머/카운터 (T1, T3)
    * 다른 프로세서에 비해 PWM 기능이 추가 
    
<br>

- 타이머/카운터의 기능  
(1) 일정 시간 간격을 갖는 펄스의 발생  
(2) 외부 사건의 계수하는 기능  
(3) PWM 펄스의 발생  

  + 타이머 응용   
    * 타이머는 주기적인 시간 간격으로 오버플로우가 발생되도록 프로그램되고 이 오버플로우가 발생할 때마다 오버플로우 플래그가 설정된다. 
    이 플래그는 펄스의 입력 상태를 확인하여 이 플래그가 발생하였으면 출력 포트에 데이터를 보내고, 또는 주기적으로 일정 시간 간격으로 어떤 일을 수행하는 등의 동작을 동기화하는데 이용된다.
    * 외부에서 발생되는 펄스의 시간 간격을 계측하기 위해 타이머를 사용하여 외부에서 입력되는 펄스보다 작은 간격을 갖는 주기적인 펄스를 만들어 
    두가지 상태(ON/OFF)의 시간을 측정하는 응용으로도 사용될 수 있음
  + 카운터 응용   
    * 외부 사건의 발생 회수를 계수하기 위해 사용됨
    * 사건은 어떤 외부적인 자극으로 ATmega128 IC의 핀에서 1 또는 0 상태로 공급되며, 이를 계수하여 사건의 발생 회수 및 사건의 발생 여부를 확인
  + PWM 응용
    * ATmega128의 타이머/카운터에는 비교 모듈(compare unit) 내장
    * 이 모듈을 이용해 일반적인 파형의 발생과 PWM 신호를 발생 

<br>

- PWM 신호  
 ![image](https://user-images.githubusercontent.com/72501562/121785008-42501200-cbf2-11eb-9a0d-760fe38c1cd4.png)
  + PWM 신호 : 일정한 주기를 갖는 신호를 Tw 시간동안 Ton의 폭으로 ON/OFF 제어를 하는 것 
  + 즉, ON 되는 시간의 펄스폭을 넓게 하면 출력되는 평균 전압이 커지게 되고, ON 되는 시간의 펄스폭(Ton)을 좁게 하면 평균 전압이 작아짐
  + --> 펄스 폭 (Ton)을 디지털 값으로 제어함으로써 평균전압의 크기를 조절하는 방식 => ***PWM제어*** 
  + ![image](https://user-images.githubusercontent.com/72501562/121785208-6102d880-cbf3-11eb-939d-b12be5a78547.png)
  + ![image](https://user-images.githubusercontent.com/72501562/121785210-68c27d00-cbf3-11eb-8bd6-e11a6b1a8527.png)  

<br>

## 7.2 8비트 타이머/카운터2의 동작  


- 타이머/카운터2의 개요  
  + 타이머/카운터2는 PWM 출력을 가지고 있는 8비트 타이머/카운터로서 프리스케일러를 통하여 내부 클럭을 입력으로 사용하여 동작하는 타이머 기능과 외부 클럭을 입력으로 사용하는 카운터 기능을 수행.  
  + 특징 
    * 단일 채널의 카운터
    * 특정값과 비교하여 일치하면 타이머의 계수 값을 자동으로 클리어하는 CTC(Clear Timer on Compare match) 모드 - auto reload모드 
    * 글리치 없는 주파수 발생기
    * 주파수 발생기
    * 외부 사건 카운터 
    * 10비트 프리스케일러
    * 오버플로우, 비교 일치 인터럽트 발생 (TOV2와 OCF2)
  + 타이머/카운터2의 내부 구성  
    * 카운터
    * 출력 비교부
    * 비교 일치 출력부 

<br>

- 카운터부의 동작  
![image](https://user-images.githubusercontent.com/72501562/121796811-cc31c680-cc56-11eb-9ca8-569fd04dc921.png)
  + T2핀에 의해 공급되는 외부클럭과 프리스케일러를 통해 공급되는 시스템 클럭에 의해 구동
  + 두 개의 클럭 신호는 클럭 선택 논리부에서 선택되어 카운터로 입력
  + 즉, 타이머/카운터2는 클럭 선택 논리부로부터 출력되는 클럭 신호 clk_T2를 입력받아 동작하는 8비트 업/다운 카운터(TCNT2)로 동작
  + 업카운터로 동작할 때는 0xFF에서 0x00으로 계수 값 천이 시 오버플로우(TOV2)인터럽트 발생  
  + TCNT2카운터는 동작모드에 따라 clk_T2의 입력에 의해 값이 증감하고 경우에 따라서는 0x00으로 리셋되기도 함
  + 클럭의 선택 : TCCR2의 클럭 선택 비트 (CS22~CS20)에 의해 결정 
  + 카운터의 계수 동작과 TOV2 플래그 : TCCR2의 파형 발생 모드 비트 (WGM21, WGM20)에 의해 결정
  + TOV2플래그는 ATmega128의 인터럽트를 발생시키는데 사용될 수 있음

<br>

- 출력 비교부의 동작  
![image](https://user-images.githubusercontent.com/72501562/121797147-65fa7300-cc59-11eb-9085-727b1dc0e6bd.png)
  + 타이머/카운터2 레지스터 (TCNT2)의 값과 이중 버퍼의 구조를 가진 출력 비교 레지스터 (OCR2)의 값은 계수 동작중에 항상 비교됨
  + 비교 결과 일치하면 출력 비교 플래그 (OCF2, Output Compare Flag2)를 세트
  + OCF2 신호에 의하여 출력 비교 인터럽트 요청
  + 또한 이 플래그 이용해 외부 핀 OC2단자에 신호가 출력되도록 설정 가능
  + 타이머/카운터의 동작모드를 적절히 설정 후 TCNT2레지스터와 OCR2레지스터를 활용하면 OC2단자에 PWM펄스를 발생하거나 가변주파수의 펄스를 만들어 출력할 수 있게됨 
  + **OC2단자의 출력 파형 결정** : TCCR2의 비교일치 출력 모드 비트 (COM21~20)와 파형 발생 모드 비트 (WGM21, WGM20)의 설정에 의해 top과 bottom 신호를 결합하여 발생 
  + OCR2 는 PWM동작 모드로 동작할 경우에는 이중 버퍼 구조로 동작
  + OCR2 는 일반 모드나 CTC모드로 동작할 때에는 이중 버퍼 구조가 해제 
  + PWM모드 : OCR2 값이 TCNT2가 top 또는 bottom에 도달했을 때 갱신 --> 홀수 길이, 비대칭 PWM펄스 발생 안함 --> 글리치 방지
  + OCR2 레지스터 엑세스 과정 : CPU가 자동으로 처리함. 
    * 이중 버퍼 사용 시 : OCR2 버퍼 레지스터 액세스
    * 이중 버퍼 미사용 시 : OCR2 레지스터 직접 액세스
  + FOC2 신호 : TCCR2의 강제 출력 비교 비트(FOC2)가 1로 설정시 발생. PWM 파형 발생 모드가 아닌 경우에 사용됨. 비교기의 결과가 일치하였다고 강제로 설정하는 기능 

<br>

- 타이머/카운터2의 레지스터  

|타이머/카운터2 레지스터|설명|
|:--:|:--|
|TCCR2|타이머/카운터2 제어 레지스터|
|TCNT2|타이머/카운터2 레지스터|
|OCR2|출력 비교 레지스터 2|
|SFIOR|특수 기능 I/O 레지스터|
|TIMSK|타이머/카운터 인터럽트 마스크 레지스터|
|TIFR|타이머/카운터 인터럽트 플래그 레지스터|  

<br>

- TCCR2 (타이머/카운터2 제어 레지스터)
  + 타이머/카운터0의 동작모드, 프리스케일러의 분주비 설정 등의 기능 수행 
  ![image](https://user-images.githubusercontent.com/72501562/121797764-51b87500-cc5d-11eb-9c88-d2b312d2f190.png)  
  + 비트7 : FOC2 (강제출력비교, Force Output Compare)
    * PWM 모드가 아닌 경우에만 유효, 이를 1로 설정하면 강제로 즉시 OC2 단자에 출력 비교가 일치된 것과 같은 출력을 내보내는 기능 
    * 유의할 점 : FOC비트는 스트로브 신호로 출력, 특별한 경우가 아니라면 0으로 설정
  + 비트 6,3 : WGM20, WGM21 (파형 발생 모드, Waveform Generation Mode)
    * 카운터의 동작 모드 설정
    * 일반 모드, CTC 모드, PWM 모드, 고속 PWM 모드

  




















